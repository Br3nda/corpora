{% extends 'corpus/base.html' %}
{% load static sekizai_tags compress sass_tags i18n %}


{% block content %}

{% addtoblock "css" %}
<style type="text/x-scss">
@import 'corpora/css/colors';
@import 'corpus/css/record';
@import 'corpus/scss/actionButtons';
@import 'corpus/scss/sentences';

@import 'bower_components/bootstrap/scss/functions';
@import 'bower_components/bootstrap/scss/mixins';
@import 'bower_components/bootstrap/scss/variables';

div.content{
  padding: 60px 0px 60px 0px;
}


</style>
{% endaddtoblock %}
  

{% include 'people/profile_header.html' %}



<div class="container sentence">

  <div class="row sentence-block disabled">
    <div class="col-lg-7 sentence"></div>
    
    <div class="col-lg-5 play">
        <div class="col-12">
          <div class="circle-button-container">
            <div class="circle background-circle">
                <a href="javascript:void(0)" id="record-button">
                    <div class="circle foreground-circle unclicked-circle record">
                        <div class="circle-text"></div>
                        <div class="stop-square"></div>
                    </div>
                </a>

                <a href="javascript:void(0)" id="play-button">
                    <div class="circle foreground-circle unclicked-circle play">
                        <div class="play-triangle"></div>
                    </div>
                </a>
            </div>
          </div>
        </div>
    </div>
    <div class="col-lg-7"></div>
    <div class="col-lg-5 actions">
      <a href="javascript:void(0)" class="auto-play auto-play-off"><i class="fa fa-play-circle fa-fw"></i><span>Auto Play</span></a>            
      {% if user.can_approve %}     
      <a href="#" class="approve"
        data-toggle="popover" 
        data-trigger="hover" 
        title="Approve" 
        data-content="{% trans 'Approve for recording?' %}"
        ><i class="fa fa-check-circle-o fa-fw"></i></a>
      {% else %}
      {% endif %}
      <a href="#" class="good"><i class="fa fa-thumbs-o-up fa-fw"></i></a>
      <a href="#" class="bad"><i class="fa fa-thumbs-o-down fa-fw"></i></a>      
    </div>

  </div>

</div>

<audio id="play-audio" style="display: none; width: 0px; height: 0px"></audio>

{% addtoblock "js" %}<script type="text/javascript" src="{% static 'bower_components/js-cookie/src/js.cookie.js' %}"></script>{% endaddtoblock %}
{% addtoblock "js" %}
<script type="text/javascript">

$('a.approve').popover({})

var csrftoken = Cookies.get('csrftoken');

function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});

var sentence_block = $('.sentence-block').get(0);


class Listen{
  constructor(){
    this.objects = null
    this.recording = null
    this.sentence = null
    this.base_url = '/api/{% if user.can_approve %}recordings{% else %}listen{%endif%}/'
    this.base_quality_url = '/api/qualitycontrol/'
    this.base_recording_url = '/api/{% if user.can_approve %}recordings{% else %}listen{%endif%}/'
    this.url_filter_query = {% if user.can_approve %}'?sort_by=listen'{% else %}''{% endif %}
    this.next_url = null
    this.quality_control = {}
    this.quality_control.person = {{ person.id }}
    this.error_loop = 0
    this.audio = document.getElementById('play-audio');
    this.quality_control.content_type = {{content_type}}
    $(sentence_block).fadeOut(0)

    var self = this
    $(sentence_block).find('.approve').off().on('click', function(e){
      if (!$(e.currentTarget).hasClass('disabled')){
        $(sentence_block).find('.approve, .good, .bad').addClass('disabled')
        self.approve();
      }
    })

    $(sentence_block).find('.good').off().on('click', function(e){
      if (!$(e.currentTarget).hasClass('disabled')){
        $(sentence_block).find('.approve, .good, .bad').addClass('disabled')
        self.up_vote();
      }
    })   

    $(sentence_block).find('.bad').off().on('click', function(e){
      if (!$(e.currentTarget).hasClass('disabled')){
        $(sentence_block).find('.approve, .good, .bad').addClass('disabled')
        self.down_vote();
      }
    })


  }

  get_recordings(){
    var self = this;
    console.log('Fetching more recordings')
    $.ajax({
        url: ((this.next_url==null) ? this.base_url : this.next_url)+this.url_filter_query,
        error: function(XMLHttpRequest, textStatus, errorThrown){
          console.log('Trying from first page')
          self.next_url=null
          self.get_recordings()
        }
        }).done(function(d){
          self.objects = d.results
          self.next_url = d.next

          console.log(self.objects.length)
          console.log(self.objects)
          console.log(d.results)
          console.log(d.results.length)
          console.log(d.results[0])

          if (self.objects.length == 0 || self.error_loop>3){
            console.log('No more recordings')
            self.all_done()
          }
          else{
            console.log(d)
            console.log(d.results)
            self.next()
          }
        }).fail(function(){
          self.next_url=null
          self.get_recordings()
        });
  }

  reload(){
    var self = this
    $.ajax({
        url: this.base_recording_url+this.recording.id+'/'
        }).done(function(d){
          console.log(d)
          self.recording.quality_control = d.quality_control
          self.recording = d
          self.sentence = d.sentence
          self.show_next_recording()
    })    
  }

  next(){
    if (this.objects == null || this.objects.length==0){
      this.get_recordings()
    } else{
      this.recording = this.objects.shift()
      this.sentence = this.recording.sentence

      if (this.recording.sentence_text == '' || this.recording.sentence_text==null){
        if (this.sentence==null){
          this.recording.sentence_text = 'These arent teh droid your looking for'
          console.log('error')
          this.error_loop+=1
          this.show_next_recording()
          this.next()
        } else { this.recording.sentence_text = this.sentence.text }
        
      }

      if (this.sentence==null && this.recording.sentence_text.length>0){
        this.sentence = {}
        this.sentence.text=this.recording.sentence_text
      }

      this.show_next_recording()
    }
  }

  all_done(){
    $(sentence_block).text('{% trans "All done."%}')
    $(sentence_block).fadeIn('disabled')
  }

  show_next_recording(){
    var self = this;
    if (this.sentence){
      $(sentence_block).removeClass('disabled')
      $(sentence_block).find('.approve, .good, .bad').removeClass('disabled')
      $(sentence_block).find('.sentence .text-area').remove()
      {% if user.can_approve %}
      var input_elm = $('<textarea class="text-area" type="textarea" name="text" rows="4">');
      {% else %}
      var input_elm = $('<span class="text-area"></span>');
      {% endif %}

      $(input_elm).val(this.recording.sentence_text);
      $(input_elm).text(this.recording.sentence_text);
      $(sentence_block).find('.sentence').append(input_elm)
      $(sentence_block).fadeIn('fast');


      $('#play-button').show();

      $.ajax({
        type: "GET",
        url: this.base_recording_url+this.recording.id+'/',
        dataType: 'json',
        error: function(XMLHttpRequest, textStatus, errorThrown){
          console.log(textStatus.responseText)
          console.log(XMLHttpRequest)
          console.log(errorThrown)
        }
      }).done(function(){
        console.log('gotted')
        self.audio.src = self.recording.audio_file_url
      }).fail(function(){
        console.log('not gotted.')
        self.next()
      })


      $(input_elm).on('change', function(){
        self.edit_sentence()
      })

      $(input_elm).on('keyup', function(event){
        self.check_sentence_changed(event)
      })

    }
  }

  check_sentence_changed(event){
    if ($(event.currentTarget).val() != this.sentence.text){
      this.edit_sentence()
    }
  }

  edit_sentence(){
    var self = this
    $(sentence_block).find('.approve, .good, .bad').addClass('disabled')
    $(sentence_block).find('.save').removeClass('off').removeClass('disabled')
    $(sentence_block).find('.save').off().on('click', function(e){
        $(e.currentTarget).addClass('disabled').off()
        self.save_sentence($(sentence_block).find('.text-area').val());
    })     
  }

  post_qc(data){
    var self = this
    this.quality_control.object_id = this.recording.id
    $.ajax({
      type: "POST",
      data: this.quality_control,
      url: this.base_quality_url,
      dataType: 'json',
      error: function(XMLHttpRequest, textStatus, errorThrown){
        console.log(XMLHttpRequest.status)
        console.log(XMLHttpRequest.responseText)
      }
    }).done(function(){
      self.next();
    }).fail(function(){
      console.log('Failed.')
    })
    return true;    
  }

  put_qc(data){
    var self = this
    $.ajax({
      type: "PUT",
      data: data,
      url: this.base_quality_url+this.quality_control_id+'/',
      dataType: 'json',
      error: function(e){
        console.log(e.responseText)
      }
    }).done(function(){
      self.next();
    }).fail(function(){
      console.log('Failed.')
    })
    return true;    
  }

  save_sentence(text){
    var self=this
    this.recording.sentence_text = text

    var data = {
      id: this.recording.id,
      sentence_text: text
    }

    $.ajax({
      type: "PUT",
      data: data,
      url: this.base_recording_url+this.recording.id+'/',
      dataType: 'json',
      error: function(XMLHttpRequest, textStatus, errorThrown){
        console.log(textStatus.responseText)
        console.log(XMLHttpRequest)
        console.log(errorThrown)
      }
    }).done(function(){
      console.log('Saved')
      self.reload();
    }).fail(function(){
      console.log('Failed.')
    })
  }

  post_put(){
    var method = 'POST'
    this.quality_control.object_id = this.recording.id
    this.audio.pause()
    if (this.recording.quality_control){
      for (let qc of this.recording.quality_control){
        if (qc.person == this.quality_control.person){
          console.log('Found matching qc ')
          this.quality_control_id = qc.id
          this.quality_control.bad += qc.bad
          this.quality_control.good += qc.good
          method = 'PUT'
        } else{
          
        }
      }
    }

    if (method=='POST'){
      this.post_qc(this.quality_control)
    } else {
      this.put_qc(this.quality_control)
    }

  }

  approve(){
    this.quality_control.approved = true;
    this.quality_control.good = 0
    this.quality_control.bad = 0    
    this.quality_control.approved_by = {{ request.user.id }};
    console.log(this.quality_control);
    this.post_put();
  }
  up_vote(){
    this.quality_control.good = 1
    this.quality_control.bad = 0
    console.log(this.quality_control);
    this.post_put();
  }

  down_vote(){
    this.quality_control.bad = 1
    this.quality_control.good = 0
    console.log(this.quality_control);
    this.post_put();
  }

}



class Player {
  constructor(){
    this.play_button_selector = '#play-button'
    this.audio_selector = '#play-audio'
    this.audio = document.getElementById('play-audio');

    var self = this;
    $(this.play_button_selector).click(function(){
      self.audio.play();
      $('.foreground-circle.play').removeClass('unclicked-circle').addClass('clicked-circle');
    });    

    // When audio is done playing back, revert button to initial state
    $(this.audio).bind('ended', function(){
      $('.foreground-circle.play').removeClass('clicked-circle').addClass('unclicked-circle');
    });

    $('a.auto-play').click(function(event){
      var obj = event.currentTarget

      if ($(obj).hasClass('auto-play-off')){
        $(obj).removeClass('auto-play-off')
        $(obj).addClass('auto-play-on')
      } else {
        $(obj).removeClass('auto-play-on')
        $(obj).addClass('auto-play-off')
      }

    })

    $(this.audio).bind('canplay', function(){
      if ($('a.auto-play').hasClass('auto-play-on')){
        self.audio.play();
      } 
    });

    $(this.audio).bind('play', function(){
      $('.foreground-circle.play').removeClass('unclicked-circle').addClass('clicked-circle');
    });

  }
    

}


listen = new Listen();
listen.next()

player = new Player();

</script>
{% endaddtoblock %}
{% endblock %}